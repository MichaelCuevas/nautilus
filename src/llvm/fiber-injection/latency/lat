#/usr/bin/sh

# Move latency directory to home directory and execute
# Functionality for Peroni

OPT=

for arg in "$@"
do
	case $arg in
		-O0)
		OPT=-O0
		shift 
		;;
		-O1)
		OPT=-O1
		shift
		;;
		-O2)
		OPT=-O2
		shift
		;;
		-O3)
		OPT=-O3
		shift
		;;
	esac
done	

source /project/llvm/9.0.0/enable
which clang

cp LatencyAnalysis.cpp ~/CAT-c/catpass/CatPass.cpp
cp CMakeLists.txt ~/CAT-c/catpass/
cp -r ./include/ ~/CAT-c/catpass/
cp -r ./src/ ~/CAT-c/catpass/

cd ~/CAT-c/
./run_me.sh

cd ~/latency

# Optimize test, library code
clang -emit-llvm $OPT -S test/latency.c -o latency_start.ll
opt -loop-simplify -lcssa -S latency_start.ll -o latency_basic.ll

# Apply transform only
clang -Xclang -load -Xclang ~/CAT/lib/CAT.so -Xclang -emit-llvm -S latency_basic.ll -o latency_transformed.ll &> latency.out

# Generate executable
clang $OPT latency_transformed.ll -o exe
